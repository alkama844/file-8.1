<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Chatty - Connect with friends and share moments" />
  <meta name="theme-color" content="#00d4ff" />
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon.png">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>Chatty - FOR YOU</title>
  <style>
    .welcome-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--gradient-bg);
      padding: var(--spacing-xl);
      text-align: center;
    }

    .welcome-logo {
      font-size: 4rem;
      margin-bottom: var(--spacing-lg);
      animation: bounce 2s infinite;
    }

    .welcome-title {
      font-size: 3rem;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--spacing-sm);
    }

    .welcome-subtitle {
      font-size: 1.2rem;
      color: var(--accent);
      margin-bottom: var(--spacing-xl);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .green-dot {
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .top-posts {
      width: 100%;
      max-width: 800px;
      margin-top: var(--spacing-xl);
    }

    .top-posts h3 {
      font-size: 1.5rem;
      margin-bottom: var(--spacing-lg);
      color: var(--text-light);
    }

    body.dark .top-posts h3 {
      color: var(--text-dark);
    }

    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient-bg);
      padding: var(--spacing-md);
    }

    .auth-card {
      background: var(--card-bg-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-large);
      padding: var(--spacing-xl);
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow-light);
      position: relative;
      overflow: hidden;
    }

    body.dark .auth-card {
      background: var(--card-bg-dark);
      border-color: var(--border-dark);
      box-shadow: var(--shadow-dark);
    }

    .auth-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .auth-header {
      text-align: center;
      margin-bottom: var(--spacing-xl);
    }

    .auth-header h1 {
      font-size: 2rem;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--spacing-sm);
    }

    .auth-tabs {
      display: flex;
      margin-bottom: var(--spacing-lg);
      background: var(--border-light);
      border-radius: var(--radius);
      padding: 4px;
    }

    body.dark .auth-tabs {
      background: var(--border-dark);
    }

    .auth-tab {
      flex: 1;
      background: none;
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: calc(var(--radius) - 4px);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-weight: 500;
      color: #666;
    }

    body.dark .auth-tab {
      color: #999;
    }

    .auth-tab.active {
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    .main-app {
      display: none;
    }

    .main-app.active {
      display: block;
    }

    .auth-section {
      display: block;
    }

    .auth-section.hidden {
      display: none;
    }

    .chat-container {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: var(--card-bg-light);
      border-left: 1px solid var(--border-light);
      transition: right var(--transition-smooth);
      z-index: 1500;
      display: flex;
      flex-direction: column;
    }

    body.dark .chat-container {
      background: var(--card-bg-dark);
      border-left-color: var(--border-dark);
    }

    .chat-container.open {
      right: 0;
    }

    .chat-toggle {
      position: fixed;
      bottom: var(--spacing-xl);
      right: var(--spacing-xl);
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all var(--transition-fast);
      z-index: 1000;
      box-shadow: var(--shadow-light);
    }

    .chat-toggle:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-neon);
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-30px);
      }
      60% {
        transform: translateY(-15px);
      }
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      .chat-container {
        width: 100%;
        right: -100%;
      }

      .welcome-title {
        font-size: 2rem;
      }

      .welcome-logo {
        font-size: 3rem;
      }
    }
  </style>
</head>
<body>
  <!-- Auth Section -->
  <div id="auth-section" class="auth-section">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1>üí¨ Chatty</h1>
          <p>Connect with friends and share moments</p>
        </div>

        <div class="auth-tabs">
          <button class="auth-tab active" onclick="switchTab('login')">Login</button>
          <button class="auth-tab" onclick="switchTab('signup')">Sign Up</button>
        </div>

        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;"></div>

        <!-- Login Form -->
        <form id="login-form" class="auth-form active">
          <div class="form-group">
            <label for="login-email">Email</label>
            <input type="email" id="login-email" name="email" required 
                   placeholder="Enter your email" autocomplete="email">
          </div>

          <div class="form-group">
            <label for="login-password">Password</label>
            <input type="password" id="login-password" name="password" required 
                   placeholder="Enter your password" autocomplete="current-password">
          </div>

          <button type="submit" class="btn btn-primary" style="width: 100%;">
            <span id="login-btn-text">üöÄ Sign In</span>
          </button>
        </form>

        <!-- Signup Form -->
        <form id="signup-form" class="auth-form">
          <div class="form-group">
            <label for="signup-fullname">Full Name</label>
            <input type="text" id="signup-fullname" name="fullName" required 
                   placeholder="Enter your full name" autocomplete="name"
                   minlength="2" maxlength="50">
          </div>

          <div class="form-group">
            <label for="signup-email">Email</label>
            <input type="email" id="signup-email" name="email" required
                   placeholder="Enter your email" autocomplete="email">
          </div>

          <div class="form-group">
            <label for="signup-password">Password</label>
            <input type="password" id="signup-password" name="password" required 
                   placeholder="Create a password" autocomplete="new-password"
                   minlength="6">
            <small>Minimum 6 characters</small>
          </div>

          <button type="submit" class="btn btn-primary" style="width: 100%;">
            <span id="signup-btn-text">‚ú® Create Account</span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Main App Section -->
  <div id="main-app" class="main-app">
    <!-- Welcome Screen -->
    <div id="welcome-screen" class="welcome-screen">
      <div class="welcome-logo">üí¨</div>
      <h1 class="welcome-title">Chatty</h1>
      <div class="welcome-subtitle">
        FOR YOU <div class="green-dot"></div>
      </div>
      
      <div class="nav-buttons" style="margin-bottom: 2rem;">
        <button class="btn btn-primary" onclick="showCreatePost()">‚ú® Create Post</button>
        <a href="/all" class="btn btn-outline">üìã All Posts</a>
        <a href="/search" class="btn btn-outline">üîç Search</a>
        <a href="/info" class="btn btn-outline">‚ÑπÔ∏è About</a>
        <a href="/admin" class="btn btn-outline">‚öôÔ∏è Admin</a>
        <button class="btn btn-outline" onclick="logout()">üö™ Logout</button>
      </div>

      <div class="top-posts">
        <h3>üî• Top Liked Posts</h3>
        <div id="top-posts-container" class="posts-container">
          <div class="loading-skeleton">
            <div class="skeleton-post"></div>
            <div class="skeleton-post"></div>
            <div class="skeleton-post"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Post Modal -->
    <div id="create-post-modal" class="lightbox" style="display: none;">
      <div class="lightbox-content" style="max-width: 600px; width: 90%;">
        <button class="lightbox-close" onclick="hideCreatePost()">&times;</button>
        <div class="card" style="margin: 0;">
          <h2>Create New Post</h2>
          <form id="post-form" method="POST" action="/api/posts" enctype="multipart/form-data">
            <div class="form-group">
              <label for="post-text">What's on your mind?</label>
              <textarea 
                id="post-text" 
                name="text" 
                placeholder="Share your thoughts, use emojis! üéâ" 
                rows="4"
              ></textarea>
            </div>

            <div class="form-group">
              <label for="file-input">Upload Files</label>
              <div class="file-upload-area" id="file-upload-area">
                <input 
                  type="file" 
                  id="file-input" 
                  name="file" 
                  multiple 
                  accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar"
                />
                <div class="file-upload-text">
                  <span>üìé Drag & drop files here or click to browse</span>
                  <small>Max 50MB per file ‚Ä¢ Images, videos, audio, documents supported</small>
                </div>
              </div>
            </div>

            <div id="file-previews" class="file-previews"></div>

            <div id="upload-progress" class="upload-progress" style="display: none;">
              <div class="progress-bar">
                <div class="progress-fill"></div>
              </div>
              <div class="progress-info">
                <span class="progress-text">Uploading...</span>
                <span class="progress-percentage">0%</span>
              </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
              <button type="button" class="btn btn-outline" onclick="hideCreatePost()">Cancel</button>
              <button type="submit" class="btn btn-primary" id="submit-btn">
                <span>üöÄ Share Post</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Toggle Button -->
  <button class="chat-toggle" id="chat-toggle" onclick="toggleChat()" style="display: none;">üí¨</button>

  <!-- Chat Container -->
  <div class="chat-container" id="chat-container">
    <div class="chat-header">
      <h3>üí¨ Messages</h3>
      <button class="chat-close" onclick="toggleChat()">√ó</button>
    </div>

    <div class="chat-users" id="chat-users">
      <div class="empty-chat">
        <p>Loading users...</p>
      </div>
    </div>

    <div class="chat-messages" id="chat-messages">
      <!-- Messages will be populated here -->
    </div>

    <div class="chat-input-container" id="chat-input-container">
      <div class="chat-input">
        <textarea 
          id="message-input" 
          placeholder="Type a message..." 
          rows="1"
          onkeydown="handleMessageInput(event)"
        ></textarea>
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Global variables
    let authUser = null;
    let socket = null;
    let selectedUser = null;
    let users = [];
    let messages = [];
    let onlineUsers = [];
    let selectedFiles = [];
    const MAX_FILE_SIZE = 50 * 1024 * 1024;

    // Theme management
    if (localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.body.classList.add('dark');
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
    });

    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/check');
        
        if (response.ok) {
          authUser = await response.json();
          showMainApp();
          connectSocket();
          loadTopPosts();
          loadUsers();
        } else {
          showAuthSection();
        }
      } catch (error) {
        console.error('Auth check error:', error);
        showAuthSection();
      }
    }

    function showAuthSection() {
      document.getElementById('auth-section').classList.remove('hidden');
      document.getElementById('main-app').classList.remove('active');
    }

    function showMainApp() {
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('main-app').classList.add('active');
      document.getElementById('chat-toggle').style.display = 'flex';
    }

    function switchTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(`${tab}-form`).classList.add('active');
      
      hideMessages();
    }

    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      document.getElementById('success-message').style.display = 'none';
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('success-message');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      document.getElementById('error-message').style.display = 'none';
    }

    function hideMessages() {
      document.getElementById('error-message').style.display = 'none';
      document.getElementById('success-message').style.display = 'none';
    }

    // Auth form handlers
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const loginBtn = document.getElementById('login-btn-text');
      
      loginBtn.textContent = 'Signing in...';
      
      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: formData.get('email'),
            password: formData.get('password')
          })
        });

        const data = await response.json();

        if (response.ok) {
          authUser = data;
          showSuccess('Login successful!');
          setTimeout(() => {
            showMainApp();
            connectSocket();
            loadTopPosts();
            loadUsers();
          }, 1000);
        } else {
          showError(data.message || 'Login failed');
        }
      } catch (error) {
        console.error('Login error:', error);
        showError('Network error. Please try again.');
      } finally {
        loginBtn.textContent = 'üöÄ Sign In';
      }
    });

    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const signupBtn = document.getElementById('signup-btn-text');
      
      signupBtn.textContent = 'Creating account...';
      
      try {
        const response = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            fullName: formData.get('fullName'),
            email: formData.get('email'),
            password: formData.get('password')
          })
        });

        const data = await response.json();

        if (response.ok) {
          authUser = data;
          showSuccess('Account created successfully!');
          setTimeout(() => {
            showMainApp();
            connectSocket();
            loadTopPosts();
            loadUsers();
          }, 1000);
        } else {
          showError(data.message || 'Registration failed');
        }
      } catch (error) {
        console.error('Registration error:', error);
        showError('Network error. Please try again.');
      } finally {
        signupBtn.textContent = '‚ú® Create Account';
      }
    });

    async function logout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
        authUser = null;
        if (socket) {
          socket.disconnect();
          socket = null;
        }
        showAuthSection();
        document.getElementById('chat-toggle').style.display = 'none';
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    // Socket connection
    function connectSocket() {
      if (!authUser) return;

      socket = io({
        query: {
          userId: authUser._id
        }
      });

      socket.on('getOnlineUsers', (userIds) => {
        onlineUsers = userIds;
        updateOnlineStatus();
      });

      socket.on('newMessage', (message) => {
        if (selectedUser && (message.senderId._id === selectedUser._id || message.receiverId._id === selectedUser._id)) {
          messages.push(message);
          displayMessages();
        }
        updateUsersList();
      });

      // WebRTC signaling for calls
      socket.on('webrtc-offer', async (data) => {
        if (currentCall && currentCall.peerConnection) {
          await currentCall.peerConnection.setRemoteDescription(data.offer);
          const answer = await currentCall.peerConnection.createAnswer();
          await currentCall.peerConnection.setLocalDescription(answer);
          
          socket.emit('webrtc-answer', {
            targetUserId: data.senderId,
            answer: answer
          });
        }
      });

      socket.on('webrtc-answer', async (data) => {
        if (currentCall && currentCall.peerConnection) {
          await currentCall.peerConnection.setRemoteDescription(data.answer);
        }
      });
      
      socket.on('webrtc-ice-candidate', async (data) => {
        if (currentCall && currentCall.peerConnection) {
          await currentCall.peerConnection.addIceCandidate(data.candidate);
        }
      });

      socket.on('incomingCall', (data) => {
        showIncomingCall(data);
      });

      socket.on('callResponse', (data) => {
        handleCallResponse(data);
      });
      
      socket.on('callEnded', (data) => {
        if (currentCall) {
          endCall();
          showNotification('Call ended by other user', 'info');
        }
      });
    }

    // Load top posts
    async function loadTopPosts() {
      try {
        const response = await fetch('/api/posts?topLiked=true');
        const posts = await response.json();
        
        const container = document.getElementById('top-posts-container');
        
        if (posts.length === 0) {
          container.innerHTML = '<div class="empty-state">No posts yet. Be the first to share something! üöÄ</div>';
          return;
        }

        container.innerHTML = posts.map(post => createPostHTML(post)).join('');
      } catch (error) {
        console.error('Error loading top posts:', error);
      }
    }

    function createPostHTML(post) {
      const timeAgo = getTimeAgo(new Date(post.createdAt));
      const isPremium = post.userId?.isPremium || false;

      let mediaHTML = '';
      if (post.media && post.media.length > 0) {
        const firstMedia = post.media[0];
        
        if (firstMedia.mimetype?.startsWith('image/')) {
          mediaHTML = `
            <div class="post-media">
              <img src="${firstMedia.url}" alt="Post image" style="max-width: 100%; border-radius: 8px;" />
            </div>
          `;
        } else if (firstMedia.mimetype?.startsWith('video/')) {
          mediaHTML = `
            <div class="post-media">
              <video controls style="max-width: 100%; border-radius: 8px;">
                <source src="${firstMedia.url}" type="${firstMedia.mimetype}">
              </video>
            </div>
          `;
        }
      }

      return `
        <div class="post-card">
          <div class="post-header">
            <div class="post-author">
              <strong>
                ${post.userId.fullName || 'Anonymous'}
                ${isPremium ? '<span class="premium-badge">‚ú® Premium</span>' : ''}
              </strong>
              <span class="post-time">${timeAgo}</span>
            </div>
          </div>
          
          ${post.text ? `<div class="post-content">${post.text}</div>` : ''}
          
          ${mediaHTML}
          
          <div class="post-actions">
            <button class="like-btn" onclick="likePost('${post._id}')">
              <span class="reaction-icon">‚ù§Ô∏è</span>
              <span class="like-count">${post.likes || 0}</span>
            </button>
            
            <button class="comment-btn">
              üí¨ <span class="comment-count">${post.comments?.length || 0}</span>
            </button>
          </div>
        </div>
      `;
    }

    async function likePost(postId) {
      try {
        const response = await fetch(`/api/posts/${postId}/like`, {
          method: 'POST'
        });
        
        if (response.ok) {
          const result = await response.json();
          const likeBtn = document.querySelector(`[onclick="likePost('${postId}')"]`);
          const likeCount = likeBtn.querySelector('.like-count');
          
          likeCount.textContent = result.likes;
          
          // Animate heart
          likeBtn.classList.add('pulse');
          setTimeout(() => likeBtn.classList.remove('pulse'), 300);
        }
      } catch (error) {
        console.error('Error liking post:', error);
      }
    }

    // Chat functionality
    function toggleChat() {
      const chatContainer = document.getElementById('chat-container');
      chatContainer.classList.toggle('open');
    }

    async function loadUsers() {
      try {
        const response = await fetch('/api/messages/users');
        if (response.ok) {
          users = await response.json();
          updateUsersList();
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function updateUsersList() {
      const container = document.getElementById('chat-users');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="empty-chat"><p>No users found</p></div>';
        return;
      }

      container.innerHTML = users.map(user => {
        const isOnline = onlineUsers.includes(user._id);
        const timeAgo = getTimeAgo(new Date(user.lastSeen));
        
        return `
          <div class="chat-user ${selectedUser && selectedUser._id === user._id ? 'active' : ''}" onclick="selectUser('${user._id}')">
            <div class="chat-avatar">
              ${user.fullName.charAt(0).toUpperCase()}
              ${isOnline ? '<div class="online-indicator"></div>' : ''}
            </div>
            <div class="chat-user-info">
              <div class="chat-user-name">
                ${user.fullName}
                ${user.isPremium ? '<span class="premium-badge">‚ú®</span>' : ''}
              </div>
              <div class="chat-user-status">
                ${isOnline ? 'Online' : `Last seen ${timeAgo}`}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateOnlineStatus() {
      updateUsersList();
    }

    async function selectUser(userId) {
      selectedUser = users.find(u => u._id === userId);
      if (!selectedUser) return;

      // Update UI
      updateUsersList();
      
      // Load messages
      try {
        const response = await fetch(`/api/messages/${userId}`);
        if (response.ok) {
          messages = await response.json();
          displayMessages();
          
          // Show chat interface
          document.getElementById('chat-messages').classList.add('active');
          document.getElementById('chat-input-container').classList.add('active');
        }
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    function displayMessages() {
      const container = document.getElementById('chat-messages');
      
      if (messages.length === 0) {
        container.innerHTML = '<div class="empty-chat"><p>No messages yet. Start the conversation!</p></div>';
        return;
      }

      container.innerHTML = messages.map(message => {
        const isOwn = message.senderId._id === authUser._id;
        const time = new Date(message.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        return `
          <div class="message ${isOwn ? 'own' : 'other'}">
            <div class="message-content">
              ${message.image ? `<img src="${message.image}" alt="Image" style="max-width: 200px; border-radius: 8px; margin-bottom: 5px;">` : ''}
              ${message.text ? message.text : ''}
            </div>
            <div class="message-time">${time}</div>
          </div>
        `;
      }).join('');
      
      container.scrollTop = container.scrollHeight;
    }

    function handleMessageInput(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    async function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      
      if (!text || !selectedUser) return;

      try {
        const response = await fetch(`/api/messages/send/${selectedUser._id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ text })
        });

        if (response.ok) {
          const message = await response.json();
          messages.push(message);
          displayMessages();
          input.value = '';
        }
      } catch (error) {
        console.error('Error sending message:', error);
      }
    }

    // Post creation
    function showCreatePost() {
      document.getElementById('create-post-modal').style.display = 'flex';
    }

    function hideCreatePost() {
      document.getElementById('create-post-modal').style.display = 'none';
      document.getElementById('post-form').reset();
      selectedFiles = [];
      displayFilePreviews();
    }

    // File upload handling
    const fileInput = document.getElementById('file-input');
    const fileUploadArea = document.getElementById('file-upload-area');

    fileUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUploadArea.classList.add('drag-over');
    });

    fileUploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      fileUploadArea.classList.remove('drag-over');
    });

    fileUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUploadArea.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files);
      handleFileSelection(files);
    });

    fileUploadArea.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      handleFileSelection(files);
    });

    function handleFileSelection(files) {
      const validFiles = [];
      
      for (const file of files) {
        if (file.size > MAX_FILE_SIZE) {
          showNotification(`File "${file.name}" is too large. Max size is 50MB.`, 'error');
          continue;
        }
        validFiles.push(file);
      }
      
      selectedFiles = [...selectedFiles, ...validFiles];
      displayFilePreviews();
    }

    function displayFilePreviews() {
      const container = document.getElementById('file-previews');
      container.innerHTML = '';
      
      if (selectedFiles.length === 0) return;
      
      selectedFiles.forEach((file, index) => {
        const preview = document.createElement('div');
        preview.className = 'file-preview';
        
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.alt = file.name;
          img.onload = () => URL.revokeObjectURL(img.src);
          preview.appendChild(img);
        } else if (file.type.startsWith('video/')) {
          const video = document.createElement('video');
          video.src = URL.createObjectURL(file);
          video.controls = true;
          video.onloadeddata = () => URL.revokeObjectURL(video.src);
          preview.appendChild(video);
        } else {
          const fileIcon = document.createElement('div');
          fileIcon.className = 'file-icon';
          fileIcon.textContent = 'üìÑ';
          preview.appendChild(fileIcon);
        }

        const fileName = document.createElement('span');
        fileName.className = 'file-name';
        fileName.textContent = file.name;
        preview.appendChild(fileName);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'file-remove';
        removeBtn.textContent = '√ó';
        removeBtn.onclick = () => removeFile(index);
        preview.appendChild(removeBtn);

        container.appendChild(preview);
      });
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      displayFilePreviews();
    }

    // Post form submission
    document.getElementById('post-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData();
      formData.append('text', document.getElementById('post-text').value);
      
      selectedFiles.forEach(file => {
        formData.append('files', file);
      });

      const submitBtn = document.getElementById('submit-btn');
      submitBtn.innerHTML = '<span>üöÄ Posting...</span>';
      submitBtn.disabled = true;
      
      try {
        const response = await fetch('/api/posts', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          showNotification('Post shared successfully! üéâ', 'success');
          hideCreatePost();
          loadTopPosts(); // Refresh posts
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Upload failed');
        }
      } catch (error) {
        console.error('Error posting:', error);
        showNotification(error.message || 'Failed to post. Please try again.', 'error');
      } finally {
        submitBtn.innerHTML = '<span>üöÄ Share Post</span>';
        submitBtn.disabled = false;
      }
    });

    // Call functionality (keeping your existing call features)
    let currentCall = null;

    function showIncomingCall(data) {
      currentCall = {
        callerId: data.callerId,
        callerName: data.callerName,
        type: data.callType,
        isInitiator: false
      };

      // Create call modal
      const modal = document.createElement('div');
      modal.id = 'call-modal';
      modal.className = 'lightbox';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="lightbox-content" style="text-align: center; background: var(--card-bg-dark); color: white; padding: 2rem; border-radius: 1rem;">
          <h3>${data.callerName} is calling...</h3>
          <p>${data.callType === 'video' ? 'Video Call' : 'Audio Call'}</p>
          <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
            <button class="btn btn-primary" onclick="acceptCall()">üìû Accept</button>
            <button class="btn btn-outline" onclick="declineCall()">üìµ Decline</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Auto-hide after 30 seconds
      setTimeout(() => {
        if (document.getElementById('call-modal')) {
          declineCall();
        }
      }, 30000);
    }

    function acceptCall() {
      if (!currentCall) return;

      socket.emit('callResponse', {
        callerId: currentCall.callerId,
        accepted: true
      });

      initializeWebRTC();
      document.getElementById('call-modal').remove();
    }

    function declineCall() {
      if (!currentCall) return;

      socket.emit('callResponse', {
        callerId: currentCall.callerId,
        accepted: false
      });

      currentCall = null;
      document.getElementById('call-modal').remove();
    }

    function handleCallResponse(data) {
      if (data.accepted) {
        initializeWebRTC();
      } else {
        showNotification(`${data.responderName} declined the call`, 'info');
        currentCall = null;
      }
    }

    function initializeWebRTC() {
      const configuration = {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      };

      const peerConnection = new RTCPeerConnection(configuration);
      currentCall.peerConnection = peerConnection;

      navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        }, 
        video: false 
      })
        .then(stream => {
          currentCall.localStream = stream;
          stream.getTracks().forEach(track => {
            peerConnection.addTrack(track, stream);
          });

          peerConnection.ontrack = (event) => {
            if (!currentCall.remoteAudio) {
              currentCall.remoteAudio = document.createElement('audio');
              currentCall.remoteAudio.autoplay = true;
              document.body.appendChild(currentCall.remoteAudio);
            }
            currentCall.remoteAudio.srcObject = event.streams[0];
          };

          peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              const targetId = currentCall.partner ? currentCall.partner._id : currentCall.callerId;
              socket.emit('webrtc-ice-candidate', {
                targetUserId: targetId,
                candidate: event.candidate
              });
            }
          };

          if (currentCall.isInitiator) {
            peerConnection.createOffer()
              .then(offer => {
                return peerConnection.setLocalDescription(offer);
              })
              .then(() => {
                socket.emit('webrtc-offer', {
                  targetUserId: currentCall.partner._id,
                  offer: peerConnection.localDescription
                });
              });
          }

          showCallControls();
        })
        .catch(error => {
          console.error('Error accessing microphone:', error);
          showNotification('Could not access microphone', 'error');
          endCall();
        });
    }

    function showCallControls() {
      const callControls = document.createElement('div');
      callControls.id = 'call-controls';
      callControls.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        text-align: center;
      `;
      
      const partnerName = currentCall.partner ? currentCall.partner.fullName : currentCall.callerName;
      
      callControls.innerHTML = `
        <div style="margin-bottom: 2rem;">
          <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 3rem; font-weight: bold;">
            ${partnerName.charAt(0).toUpperCase()}
          </div>
          <h2 style="margin: 0 0 0.5rem 0; font-size: 2rem;">${partnerName}</h2>
          <p style="margin: 0; color: var(--accent); font-size: 1.1rem;">Connected</p>
        </div>
        <div style="display: flex; gap: 2rem; justify-content: center;">
          <button onclick="endCall()" style="background: #ff4757; color: white; border: none; padding: 1.2rem; border-radius: 50%; cursor: pointer; width: 80px; height: 80px; font-size: 1.5rem;">
            üìµ
          </button>
        </div>
      `;
      
      document.body.appendChild(callControls);
    }

    function endCall() {
      if (currentCall) {
        if (currentCall.peerConnection) {
          currentCall.peerConnection.close();
        }
        
        if (currentCall.localStream) {
          currentCall.localStream.getTracks().forEach(track => track.stop());
        }
        
        if (currentCall.remoteAudio) {
          currentCall.remoteAudio.remove();
        }
        
        const callControls = document.getElementById('call-controls');
        if (callControls) {
          callControls.remove();
        }
        
        const targetId = currentCall.partner ? currentCall.partner._id : currentCall.callerId;
        if (socket && targetId) {
          socket.emit('callEnded', { targetUserId: targetId });
        }
        
        currentCall = null;
        showNotification('Call ended', 'info');
      }
    }

    // Utility functions
    function getTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) return 'just now';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
      if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
      
      return date.toLocaleDateString();
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
  </script>
</body>
</html>